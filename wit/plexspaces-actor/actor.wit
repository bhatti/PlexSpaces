// PlexSpaces Actor Interface - Actor Exports
//
// Functions that WASM actors must implement.
// The runtime calls these functions to interact with actors.

interface actor {
    use types.{actor-id, payload, actor-result, actor-error};

    /// Initialize actor with state
    ///
    /// Called ONCE when actor is first created or recovered.
    /// Actor should deserialize initial-state and set up internal state.
    ///
    /// # Arguments
    /// - `initial-state`: State bytes (empty for new actor, snapshot for recovered)
    ///
    /// # Returns
    /// - `ok`: Initialization successful
    /// - `err`: Initialization failed (actor will be terminated)
    ///
    /// # Lifecycle
    /// 1. Runtime creates WASM instance
    /// 2. Runtime calls `init(initial_state)`
    /// 3. If init succeeds, actor is ready to receive messages
    /// 4. If init fails, actor is terminated
    init: func(initial-state: payload) -> result<_, string>;

    /// Handle incoming message (generic handler)
    ///
    /// Called for every message received by the actor.
    /// This is the primary message handler.
    ///
    /// # Arguments
    /// - `from`: Sender actor ID
    /// - `msg-type`: Message type (e.g., "call", "cast", "info")
    /// - `payload`: Message payload bytes
    ///
    /// # Returns
    /// - `ok(response)`: Message processed, response payload (may be empty)
    /// - `err`: Message processing failed
    ///
    /// # Message Types
    /// - "call": Synchronous request, MUST return response
    /// - "cast": Asynchronous message, response ignored
    /// - "info": System message (timer, monitor notification)
    ///
    /// # Example (Rust)
    /// ```rust
    /// fn handle_message(from: String, msg_type: String, payload: Vec<u8>) -> ActorResult {
    ///     match msg_type.as_str() {
    ///         "call" => handle_call(from, payload),
    ///         "cast" => { handle_cast(from, payload); ActorResult::Ok(vec![]) },
    ///         _ => ActorResult::Err(format!("Unknown message type: {}", msg_type)),
    ///     }
    /// }
    /// ```
    handle-message: func(from-actor: actor-id, msg-type: string, payload: payload) -> actor-result;

    /// Snapshot actor state for persistence
    ///
    /// Called periodically by runtime for checkpointing.
    /// Also called during graceful shutdown.
    /// Actor should serialize its complete state.
    ///
    /// # Returns
    /// - `ok(state)`: Serialized state bytes
    /// - `err`: Snapshot failed (actor may be terminated)
    ///
    /// # Notes
    /// - State should be deterministic (same state = same bytes)
    /// - Keep state size reasonable (< 10MB recommended)
    /// - Use efficient serialization (protobuf, msgpack)
    snapshot-state: func() -> result<payload, string>;

    /// Graceful shutdown
    ///
    /// Called before actor is terminated.
    /// Actor should clean up resources, flush buffers, etc.
    ///
    /// # Returns
    /// - `ok`: Shutdown successful
    /// - `err`: Shutdown failed (runtime will force terminate)
    ///
    /// # Timeout
    /// Runtime enforces shutdown timeout (configurable, default 30s).
    /// After timeout, actor is force-terminated.
    shutdown: func() -> result<_, string>;

    // =========================================================================
    // Optional: Behavior-specific handlers
    //
    // Actors MAY implement these for specific behavior patterns.
    // If not implemented, runtime falls back to handle-message.
    // =========================================================================

    /// Handle synchronous request (GenServer pattern)
    ///
    /// Called for "call" messages when actor implements GenServer behavior.
    /// MUST return a response.
    ///
    /// # Arguments
    /// - `from`: Sender actor ID (for reply routing)
    /// - `request`: Request payload
    ///
    /// # Returns
    /// Response payload (MUST be provided)
    handle-call: func(from-actor: actor-id, request: payload) -> actor-result;

    /// Handle asynchronous message (GenServer pattern)
    ///
    /// Called for "cast" messages when actor implements GenServer behavior.
    /// Response is ignored.
    ///
    /// # Arguments
    /// - `message`: Message payload
    handle-cast: func(message: payload) -> result<_, string>;

    /// Handle info message (GenServer pattern)
    ///
    /// Called for system messages (timers, monitors, etc.)
    ///
    /// # Arguments
    /// - `message`: Info message payload
    handle-info: func(message: payload) -> result<_, string>;

    /// Handle event (GenEvent pattern)
    ///
    /// Called for event notifications.
    /// Actor processes event but does not respond.
    ///
    /// # Arguments
    /// - `event-type`: Type of event
    /// - `event`: Event payload
    handle-event: func(event-type: string, event: payload) -> result<_, string>;

    /// Handle state transition (GenFSM pattern)
    ///
    /// Called for state machine transitions.
    /// Returns new state name.
    ///
    /// # Arguments
    /// - `current-state`: Current state name
    /// - `event`: Triggering event
    ///
    /// # Returns
    /// - `ok(new-state)`: New state name
    /// - `err`: Transition failed
    handle-transition: func(current-state: string, event: payload) -> result<string, string>;

    /// Get current FSM state (GenFSM pattern)
    ///
    /// Returns current state name for state machine actors.
    get-state: func() -> string;

    // =========================================================================
    // Optional: Lifecycle hooks
    // =========================================================================

    /// Called after successful initialization
    ///
    /// Use for post-init setup that requires messaging.
    post-init: func() -> result<_, string>;

    /// Called when actor is about to be suspended
    ///
    /// Actor can clean up before suspension (e.g., for migration).
    pre-suspend: func() -> result<_, string>;

    /// Called when actor is resumed after suspension
    ///
    /// Actor can restore connections, timers, etc.
    post-resume: func() -> result<_, string>;
}
